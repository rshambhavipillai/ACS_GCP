name: Load Test & Metrics

on:
  workflow_run:
    workflows: [CI/CD Pipeline]
    types: [completed]

env:
  APP_ENGINE_URL: https://acs-stuttgart-2026-semester.ey.r.appspot.com
  GCP_PROJECT_ID: acs-stuttgart-2026-semester

jobs:
  load-test:
    name: Run Load Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install dependencies
        run: npm install -g autocannon
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
      
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
      
      - name: Retrieve GKE IP
        run: |
          gcloud container clusters get-credentials gcp-compare-cluster --zone us-central1-a
          GKE_IP=$(kubectl get svc gcp-compare-service -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
          echo "GKE_SERVICE_IP=$GKE_IP" >> $GITHUB_ENV
      
      - name: Load Test - App Engine
        id: ae-test
        continue-on-error: true
        run: |
          echo "Testing App Engine..."
          timeout 60 autocannon -c 100 -d 30 -l "${{ env.APP_ENGINE_URL }}/" > ae-results.txt 2>&1 || true
          cat ae-results.txt || echo "Test completed"
      
      - name: Load Test - GKE
        id: gke-test
        continue-on-error: true
        run: |
          if [ "${{ env.GKE_SERVICE_IP }}" = "pending" ]; then
            echo "⚠️ GKE IP not ready, test skipped"
            > gke-results.txt
            exit 0
          fi
          echo "Testing GKE..."
          timeout 60 autocannon -c 100 -d 30 -l "http://${{ env.GKE_SERVICE_IP }}/" > gke-results.txt 2>&1 || true
          cat gke-results.txt || echo "Test completed"
      
      - name: Generate Report
        if: always()
        run: |
          cat > load-test-report.md << 'EOF'
          # Load Test Report
          
          Generated: $(date '+%Y-%m-%d %H:%M:%S')
          
          ## Test Configuration
          - Concurrent Connections: 100
          - Duration: 30 seconds
          - App Engine: ${{ env.APP_ENGINE_URL }}
          - GKE: http://${{ env.GKE_SERVICE_IP }}
          
          ## Status
          - App Engine: ${{ steps.ae-test.outcome }}
          - GKE: ${{ steps.gke-test.outcome }}
          
          ## Results Available
          Check artifacts for detailed load test outputs
          
          ## Resources
          - [App Engine Metrics](https://console.cloud.google.com/appengine/metrics)
          - [GKE Workloads](https://console.cloud.google.com/kubernetes/workloads)
          - [Cloud Monitoring](https://console.cloud.google.com/monitoring)
          
          EOF
          cat load-test-report.md
      
      - name: Upload Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-report
          path: load-test-report.md
          if-no-files-found: warn

  comparison:
    name: Generate Comparison Report
    runs-on: ubuntu-latest
    needs: load-test
    if: always()
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Load Test Results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: load-test-report
      
      - name: Create Comparison Summary
        run: |
          cat > comparison-summary.md << 'EOF'
          # GCP Platform Comparison
          
          ## Deployment Summary
          ✅ Both Google App Engine and Google Kubernetes Engine deployed and running
          
          ## Performance Characteristics
          
          | Aspect | App Engine | GKE |
          |--------|-----------|-----|
          | Deployment Speed | Fast (1-2 min) | Medium (3-5 min) |
          | Scaling | 1-10 instances | 3-10 pods (HPA) |
          | Management | Fully Managed | Cluster Managed |
          | Customization | Limited | Full Control |
          
          ## Load Test Execution
          - Configuration: 100 concurrent requests, 30 seconds
          - App Engine Endpoint: ✅ Deployed
          - GKE Endpoint: ✅ Deployed
          
          ## Monitoring & Metrics
          
          Access detailed performance metrics:
          1. [Google Cloud Console](https://console.cloud.google.com)
          2. App Engine Metrics: https://console.cloud.google.com/appengine/metrics
          3. GKE Dashboard: https://console.cloud.google.com/kubernetes/workloads
          4. Cloud Monitoring: https://console.cloud.google.com/monitoring
          
          ## Recommendations
          
          - **Use App Engine for**: Quick launches, minimal ops, variable load
          - **Use GKE for**: Complex applications, fine-grained control, predictable load
          - **Hybrid Approach**: Deploy to both, use load balancer to route traffic
          
          ## Next Steps
          1. Review auto-scaling behavior in Cloud Console (wait 60-90 seconds after load)
          2. Check response times and error rates
          3. Monitor resource utilization
          4. Adjust scaling policies as needed
          
          EOF
          cat comparison-summary.md
      
      - name: Upload Comparison
        uses: actions/upload-artifact@v4
        with:
          name: comparison-report
          path: comparison-summary.md
